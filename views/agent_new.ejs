<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agent Management | Customer Care</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />

  <style>
    :root {
      --bg-body: #f9fafb;
      --indigo-accent: #4f46e5;
      --border-color: #e5e7eb;
      --success-green: #10b981;
    }

    body {
      background-color: var(--bg-body);
      font-family: 'Inter', sans-serif;
      color: #111827;
      margin: 0;
    }

    /* --- Sidebar Component --- */
    .sidebar-nav {
      width: 260px;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      background: #1e293b;
      color: #cbd5e1;
      z-index: 1030;
      display: flex;
      flex-direction: column;
      padding: 1.5rem 1rem;
    }

    .nav-scroll-container {
      flex-grow: 1;
      overflow-y: auto;
      padding-right: 4px;
    }

    .nav-scroll-container::-webkit-scrollbar { width: 5px; }
    .nav-scroll-container::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.2); border-radius: 10px; }

    /* --- Main Layout --- */
    .main-content {
      margin-left: 260px;
      padding: 40px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container-custom {
      width: 100%;
      max-width: 850px;
    }

    .form-card {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      padding: 2.5rem;
      margin-bottom: 2rem;
    }

    /* --- Section Styling --- */
    .section-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      font-weight: 700;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
    }
    .section-label::after { content: ""; flex-grow: 1; height: 1px; background: var(--border-color); margin-left: 12px; }

    /* --- Pending Request Styling --- */
    .request-card { border: 1px solid #ffeeba; background-color: #fffdf5; }
    .avatar-initial {
        width: 38px; height: 38px;
        background: var(--indigo-accent);
        color: white; border-radius: 10px;
        display: flex; align-items: center; justify-content: center; font-weight: 600;
    }
    .reason-bubble {
        background: #f3f4f6; padding: 6px 12px; border-radius: 8px;
        font-size: 0.8rem; border: 1px solid var(--border-color);
    }

    .btn-create {
      background-color: #111827;
      border: none; padding: 0.8rem;
      font-weight: 600; border-radius: 10px;
      color: white; width: 100%;
    }

    @media (max-width: 992px) {
      .main-content { margin-left: 0; padding: 20px; }
      .sidebar-nav { display: none; }
    }
  </style>
</head>
<body>

  <%- include("./imports/adminSidebar") %>
  <%- include("./imports/adminTopbar") %>
  <div class="main-content mt-5">
    <div class="container-custom">
      
      <div class="page-title d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold h3 mb-1">Customer Care Management</h2>
            <p class="text-muted small mb-0">Manage internal agents and access requests.</p>
        </div>
        <button class="btn btn-dark btn-sm rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#agentsModal">
            <i class="fa-solid fa-users me-2"></i>Agent List
        </button>
      </div>

      <% if (requests && requests.length > 0) { %>
        <div class="form-card request-card">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="fw-bold mb-0 text-dark">ðŸ•’ Pending Requests</h5>
            <span class="badge rounded-pill bg-warning text-dark"><%= requests.length %> New</span>
          </div>

          <div class="table-responsive">
            <table class="table align-middle table-borderless">
              <thead>
                <tr class="text-muted small text-uppercase">
                  <th>Applicant</th>
                  <th>Reason</th>
                  <th class="text-end">Action</th>
                </tr>
              </thead>
              <tbody>
<% requests.forEach(r => { %>
  <tr class="border-bottom">
    <td class="py-3">
      <div class="d-flex align-items-center">
        <div class="avatar-initial me-3"><%= r.name.charAt(0) %></div>
        <div>
          <div class="fw-bold small text-dark"><%= r.name %></div>
          <div class="text-muted extra-small"><%= r.email %></div>
          <% if (r.phone) { %>
            <div class="text-muted extra-small" style="font-size: 0.7rem;">
              <i class="fa-solid fa-phone me-1" style="font-size: 0.65rem;"></i><%= r.phone %>
            </div>
          <% } %>
        </div>
      </div>
    </td>
    
    <td>
      <div class="reason-bubble">
        <%= r.reason || "Team Access Request" %>
      </div>
    </td>

    <td class="text-end">
        <div class="d-flex justify-content-end gap-2">
            <form method="POST" action="/admin/agent-requests/<%= r._id %>/approve">
                <button class="btn btn-sm btn-success rounded-pill px-3 fw-medium">Approve</button>
            </form>
            <form method="POST" action="/admin/agent-requests/<%= r._id %>/reject">
                <button class="btn btn-sm btn-outline-danger rounded-pill px-3 fw-medium">Reject</button>
            </form>
        </div>
    </td>
  </tr>
<% }) %>
              </tbody>
            </table>
          </div>
        </div>
      <% } %>

      <div class="form-card">
        <div class="section-label">Create Internal Profile</div>
        
        <% if (error) { %><div class="alert alert-danger py-2 small"><%= error %></div><% } %>
        <% if (success) { %><div class="alert alert-success py-2 small"><%= success %></div><% } %>

          <form method="POST" action="/admin/agents">

         

          <div class="section-label">Agent Profile</div>



          <div class="mb-3">

            <label class="form-label">Full Name</label>

            <div class="input-group">

                <span class="input-group-text bg-transparent border-end-0 text-muted"><i class="fa-regular fa-user"></i></span>

                <input name="name" class="form-control border-start-0 ps-0" placeholder="e.g. David Smith" required />

            </div>

          </div>



          <div class="mb-3">

            <label class="form-label">Email</label>

            <div class="input-group">

                <span class="input-group-text bg-transparent border-end-0 text-muted"><i class="fa-regular fa-envelope"></i></span>

                <input name="email" type="email" class="form-control border-start-0 ps-0" placeholder="david.s@droppoint.com" required />

            </div>

          </div>



          <div class="mb-4">

            <label class="form-label">Phone Number</label>

            <div class="input-group">

                <span class="input-group-text bg-transparent border-end-0 text-muted"><i class="fa-solid fa-phone-flip"></i></span>

                <input name="phone" class="form-control border-start-0 ps-0" placeholder="+91 XXXXX XXXXX" />

            </div>

          </div>



          <div class="section-label">Administrative Level</div>



          <div class="mb-4">

            <label class="form-label">Designated Role</label>

            <select name="role" class="form-select">

              <option value="agent">Standard Care Agent</option>

              <option value="supervisor">Operations Supervisor</option>

              <option value="admin">System Administrator</option>

            </select>

          </div>



          <button class="btn btn-create">

            <i class="fa-solid fa-user-plus me-2"></i> Create Agent Account

          </button>



          <p class="helper-text mt-2">

            <i class="fa-brands fa-google me-1"></i> Agent will use Google OAuth to log in via provided email.

          </p>



        </form>
      </div>

    </div>
  </div>

  <div class="modal fade" id="agentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow-lg border-0" style="border-radius: 20px;">
        <div class="modal-header border-0 pt-4 px-4">
          <h5 class="modal-title fw-bold">Active Support Team</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body px-4 pb-4">
          
          <div class="input-group mb-4 bg-light rounded-pill px-3 py-1 border">
            <span class="input-group-text bg-transparent border-0 text-muted"><i class="fa-solid fa-magnifying-glass"></i></span>
            <input type="text" id="agentSearch" class="form-control bg-transparent border-0 shadow-none" placeholder="Search by name, email or role...">
          </div>

          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table align-middle" id="agentTable">
              <thead>
                <tr class="text-muted small text-uppercase">
                  <th>Agent</th>
                  <th>Role</th>
                  <th>Contact</th>
                </tr>
              </thead>
              <tbody>
                <% if (agents && agents.length > 0) { %>
                  <% agents.forEach(agent => { %>
                    <tr class="agent-item">
                      <td class="py-3">
                        <div class="fw-bold agent-name"><%= agent.name %></div>
                        <div class="small text-muted agent-email"><%= agent.email %></div>
                      </td>
                      <td>
                        <span class="badge bg-light text-dark border agent-role"><%= agent.role.toUpperCase() %></span>
                      </td>
                      <td class="small text-muted"><%= agent.phone || 'N/A' %></td>
                    </tr>
                  <% }) %>
                <% } else { %>
                  <tr><td colspan="3" class="text-center py-4 text-muted">No agents onboarded yet.</td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Live Search Logic
    document.getElementById('agentSearch').addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      const rows = document.querySelectorAll('#agentTable .agent-item');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  </script>
</body>
</html>