<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>

  <!-- Bootstrap & Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />

  <!-- Custom Styles -->
  <style>
    body {
      background: linear-gradient(135deg, #6e8efb, #a777e3);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
    }

    .card {
      border-radius: 15px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      background: rgba(255, 255, 255, 0.97);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      height: 100%;
    }

    .card-body {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .table-responsive {
      flex: 1;
      overflow: auto;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
      background: #5a67d8;
      border: none;
      border-radius: 8px;
    }

    .form-control {
      border-radius: 8px;
    }

    .badge {
      font-size: 0.9em;
      padding: 6px 12px;
      border-radius: 12px;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .table th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #cfe2ff;
    }
  </style>
</head>

<body class="min-vh-100">

  <!-- Top Navigation Bar -->
  <%- include("./imports/adminTopbar") %>

  <div class="d-flex" style="padding-top: 56px; height: calc(100vh - 56px);">

    <!-- Sidebar -->
    <%- include("./imports/adminSidebar") %>

    <!-- Main Content -->
    <div class="flex-grow-1 p-3" style="margin-left: 250px; height: 100%;">

      <!-- FULL SCREEN CARD WRAPPER -->
      <div style="height: 100%;">
        <div class="card fade-in h-100">
          <div class="card-body">

            <!-- Search -->
            <div class="mb-3">
              <input type="text" id="parcelSearch" class="form-control"
                placeholder="Search by Locker ID, Compartment ID, Name or Phone" onkeyup="filterParcels()" />
            </div>

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h3 class="mb-0">
                <i class="fas fa-list me-2"></i>All Active Parcels
              </h3>

              <div class="d-flex gap-2">
                <div class="dropdown">
                  <button class="btn btn-outline-primary dropdown-toggle" type="button" id="statusFilterBtn"
                    data-bs-toggle="dropdown">
                    <i class="fas fa-filter me-1"></i> Filter by Status
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" data-status="all">All</a></li>
                    <li><a class="dropdown-item" href="#" data-status="awaiting_drop">Awaiting Drop</a></li>
                    <li><a class="dropdown-item" href="#" data-status="awaiting_pick">Awaiting Pick</a></li>
                    <li><a class="dropdown-item" href="#" data-status="completed">Completed</a></li>
                    <li><a class="dropdown-item" href="#" data-status="cancelled">Cancelled</a></li>
                  </ul>
                </div>

                <a href="/admin/dashboard" class="btn btn-outline-secondary">
                  <i class="fas fa-arrow-left me-2"></i>Back
                </a>
              </div>
            </div>

            <% if (bookings.length === 0) { %>
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>No active parcels found.
              </div>
            <% } else { %>

            <!-- TABLE -->
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-primary">
                  <tr>
                    <th>Status</th>
                    <th>Locker</th>
                    <th>Compartment</th>
                    <th>Sender</th>
                    <th>Receiver</th>
                    <th>Phone</th>
                    <th>OTP</th>
                    <th>Payment</th>
                    <th>Created</th>
                    <th>Expires</th>
                  </tr>
                </thead>
                <tbody>
                  <% bookings.forEach(booking => { %>
                    <tr data-status="<%= booking.status %>">

                      <td>
                        <% 
                          let badgeClass = "bg-secondary";
                          if (booking.status === "awaiting_drop") badgeClass = "bg-warning text-dark";
                          else if (booking.status === "awaiting_pick") badgeClass = "bg-danger";
                          else if (booking.status === "completed") badgeClass = "bg-success";
                          else if (booking.status === "cancelled") badgeClass = "bg-dark";
                        %>
                        <span class="badge <%= badgeClass %>"><%= booking.status %></span>
                      </td>

                      <td><%= booking.lockerId || "NA" %></td>
                      <td><%= booking.compartmentId %></td>
                      <td><%= booking.senderName %></td>
                      <td><%= booking.receiverName %></td>
                      <td><%= booking.receiverPhone %></td>
                      <td><%= booking.otp %></td>

                      <td>
                        <span class="badge <%= booking.paymentStatus === 'completed' ? 'bg-success' : 'bg-warning text-dark' %>">
                          <%= booking.paymentStatus %>
                        </span>
                      </td>

                      <td><%= new Date(booking.createdAt).toLocaleString() %></td>
                      <td><%= new Date(booking.expiresAt).toLocaleString() %></td>

                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>

            <% } %>

          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function filterParcels() {
      const input = document.getElementById("parcelSearch");
      const filter = input.value.toLowerCase();
      const rows = document.querySelectorAll("table tbody tr");

      rows.forEach(row => {
        const cells = row.getElementsByTagName("td");
        let match = false;

        for (let i of [1, 2, 3, 4, 5]) {
          if (cells[i] && cells[i].textContent.toLowerCase().includes(filter)) {
            match = true;
            break;
          }
        }

        row.style.display = match ? "" : "none";
      });
    }

    const filterLinks = document.querySelectorAll('.dropdown-menu .dropdown-item');
    const statusBtn = document.getElementById('statusFilterBtn');

    filterLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const selectedStatus = link.getAttribute('data-status');

        const rows = document.querySelectorAll('table tbody tr');

        rows.forEach(row => {
          const rowStatus = row.getAttribute('data-status');
          if (selectedStatus === 'all' || rowStatus === selectedStatus) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });

        const label = selectedStatus.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
        statusBtn.innerHTML = `<i class="fas fa-filter me-1"></i> ${label}`;
      });
    });
  </script>

</body>
</html>
