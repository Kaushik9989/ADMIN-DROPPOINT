<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Active Parcels | Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />

  <style>
    :root {
      --bg-body: #f8fafc;
      --border-color: #e2e8f0;
      --indigo-accent: #4f46e5;
    }

    body {
      background-color: var(--bg-body);
      font-family: 'Inter', sans-serif;
      color: #1e293b;
      overflow-x: hidden;
    }

    .main-content {
      margin-left: 260px;
      padding-top: 80px; /* Aligned with topbar */
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .content-wrapper {
      padding: 1.5rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Main Container Card */
    .data-card {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    /* Search & Filter Bar */
    .toolbar {
      padding: 1.25rem;
      border-bottom: 1px solid var(--border-color);
      background: #ffffff;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-wrapper {
      position: relative;
      flex-grow: 1;
      min-width: 300px;
    }

    .search-wrapper i {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
    }

    .form-search {
      padding-left: 40px;
      background: #f1f5f9;
      border: 1px solid transparent;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .form-search:focus {
      background: white;
      border-color: var(--indigo-accent);
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }

    /* Modern Table Styling */
    .table-container {
      flex: 1;
      overflow: auto;
    }

    .table {
      margin-bottom: 0;
      border-collapse: separate;
      border-spacing: 0;
    }

    .table thead th {
      position: sticky;
      top: 0;
      background: #f8fafc;
      z-index: 10;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      padding: 1rem;
      border-bottom: 2px solid var(--border-color);
    }

    .table tbody td {
      padding: 1rem;
      font-size: 0.875rem;
      vertical-align: middle;
      border-bottom: 1px solid #f1f5f9;
      color: #334155;
    }

    .table tbody tr:hover {
      background-color: #f1f5f9;
    }

    /* Refined Badges */
    .status-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: capitalize;
    }

    .badge-awaiting_drop { background: #fef3c7; color: #92400e; }
    .badge-awaiting_pick { background: #dcfce7; color: #166534; } /* Green implies safe in locker */
    .badge-completed { background: #f1f5f9; color: #475569; }
    .badge-cancelled { background: #fee2e2; color: #991b1b; }

    .otp-code {
      font-family: 'Monaco', 'Consolas', monospace;
      color: var(--indigo-accent);
      font-weight: 700;
      letter-spacing: 1px;
    }

    @media (max-width: 992px) { .main-content { margin-left: 0; } }
  </style>
</head>

<body>
  <%- include("./imports/adminTopbar") %>
  <%- include("./imports/adminSidebar") %>

  <div class="main-content">
    <div class="content-wrapper">
      
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="fw-bold mb-1 text-dark">Active Parcels</h2>
          <p class="text-muted small mb-0">Real-time monitoring of all locker logistics.</p>
        </div>
        <div class="d-flex gap-2">
          <div class="dropdown">
            <button class="btn btn-white border rounded-pill px-4 shadow-sm dropdown-toggle" id="statusFilterBtn" data-bs-toggle="dropdown">
              <i class="fas fa-filter me-2 text-muted"></i> All Statuses
            </button>
            <ul class="dropdown-menu shadow-lg border-0">
              <li><a class="dropdown-item" href="#" data-status="all">All Parcels</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" data-status="awaiting_drop">Awaiting Drop</a></li>
              <li><a class="dropdown-item" href="#" data-status="awaiting_pick">Awaiting Pick</a></li>
              <li><a class="dropdown-item" href="#" data-status="completed">Completed</a></li>
              <li><a class="dropdown-item" href="#" data-status="cancelled">Cancelled</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="data-card">
        <div class="toolbar">
          <div class="search-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="parcelSearch" class="form-control form-search" 
                   placeholder="Search ID, recipient name, or phone number..." onkeyup="filterParcels()">
          </div>
        </div>

        <% if (bookings.length === 0) { %>
          <div class="text-center py-5">
            <i class="fas fa-box-open fs-1 text-light mb-3"></i>
            <p class="text-muted">No parcel records found in system.</p>
          </div>
        <% } else { %>

          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Location/Unit</th>
                  <th>Sender Info</th>
                  <th>Recipient Info</th>
                  <th>OTP</th>
                  <th>Payment</th>
                  <th>Timestamps</th>
                </tr>
              </thead>
              <tbody>
                <% bookings.forEach(booking => { %>
                  <tr data-status="<%= booking.status %>">
                    <td>
                      <span class="status-badge badge-<%= booking.status %>">
                        <%= booking.status.replace('_', ' ') %>
                      </span>
                    </td>
                    <td>
                      <div class="fw-bold"><%= booking.lockerId %></div>
                      <div class="text-muted small">Comp: <%= booking.compartmentId %></div>
                    </td>
                    <td>
                      <div class="small fw-semibold"><%= booking.senderName %></div>
                    </td>
                    <td>
                      <div class="small fw-semibold"><%= booking.receiverName %></div>
                      <div class="text-muted small"><i class="fa-solid fa-phone-flip me-1"></i><%= booking.receiverPhone %></div>
                    </td>
                    <td><span class="otp-code"><%= booking.otp %></span></td>
                    <td>
                      <span class="text-<%= booking.paymentStatus === 'completed' ? 'success' : 'warning' %> fw-bold small">
                        ‚óè <%= booking.paymentStatus.toUpperCase() %>
                      </span>
                    </td>
                    <td>
                      <div class="small">Created: <%= new Date(booking.createdAt).toLocaleDateString() %></div>
                      <div class="text-danger small fw-medium">Exp: <%= new Date(booking.expiresAt).toLocaleDateString() %></div>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function filterParcels() {
      const filter = document.getElementById("parcelSearch").value.toLowerCase();
      const rows = document.querySelectorAll("table tbody tr");

      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(filter) ? "" : "none";
      });
    }

    const filterLinks = document.querySelectorAll('.dropdown-item');
    const statusBtn = document.getElementById('statusFilterBtn');

    filterLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const selectedStatus = link.getAttribute('data-status');
        const rows = document.querySelectorAll('table tbody tr');

        rows.forEach(row => {
          const rowStatus = row.getAttribute('data-status');
          row.style.display = (selectedStatus === 'all' || rowStatus === selectedStatus) ? '' : 'none';
        });

        statusBtn.innerHTML = `<i class="fas fa-filter me-2 text-muted"></i> ${link.innerText}`;
      });
    });
  </script>
</body>
</html>