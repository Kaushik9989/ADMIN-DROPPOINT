
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>

  <!-- Bootstrap & Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />

  <!-- Google Maps (optional, not used since OpenStreetMap is implemented) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>

  <style>
    body {
      background: linear-gradient(135deg, #6e8efb, #a777e3);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .card {
      border-radius: 15px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      background: rgba(255, 255, 255, 0.95);
    }

    .btn-primary {
      background: #5a67d8;
      border: none;
      border-radius: 8px;
      padding: 12px;
    }

    .btn-primary:hover {
      background: #4c51bf;
    }

    .form-control:focus {
      border-color: #5a67d8;
      box-shadow: 0 0 8px rgba(90, 103, 216, 0.3);
    }

    #suggestions {
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>

<body class="bg-light min-vh-100">
  <!-- Top Navigation -->
  <%- include("./imports/adminTopbar") %>

  <div class="d-flex" style="padding-top: 56px;">
    <!-- Sidebar -->
    <%- include("./imports/adminSidebar") %>

    <!-- Main Content -->
    <div class="flex-grow-1" style="margin-left: 250px;">
      <div class="container py-5">
        <div class="card p-4 fade-in">
          <h3 class="mb-4 text-primary">
            <i class="fas fa-map-marker-alt me-2"></i>Add New Locker
          </h3>

          <% if (messages.success && messages.success.length> 0) { %>
            <div class="alert alert-success">
              <%= messages.success[0] %>
            </div>
            <% } %>

              <% if (messages.error && messages.error.length> 0) { %>
                <div class="alert alert-danger">
                  <%= messages.error[0] %>
                </div>
                <% } %>

                  <form action="/admin/add-locker" method="POST">
                    <div class="row g-3 mb-3">

                      <!-- Locker ID -->
                      <div class="col-md-6">
                        <label for="lockerId" class="form-label">
                          <i class="fas fa-id-badge me-2"></i>Locker ID
                        </label>
                        <input type="text" class="form-control" id="lockerId" name="lockerId" required />
                      </div>

                      <!-- Location Search -->
                      <div class="col-md-12">
                        <label for="locationSearch" class="form-label">
                          <i class="fas fa-map-pin me-2"></i>Search Locker Location
                        </label>
                        <input type="text" id="locationSearch" class="form-control" placeholder="Enter a location"
                          required />
                        <ul id="suggestions" class="list-group mt-1 position-absolute w-50"></ul>
                      </div>
                      <button type="button" id="getLocationBtn" class="btn btn-outline-primary mt-2">
                        üìç Use My Location
                      </button>


                      <input type="hidden" name="address" id="addressField" />
                      <input type="hidden" name="lat" id="latField" />
                      <input type="hidden" name="lng" id="lngField" />

                      <!-- Compartments -->
                      <div class="col-12">
                        <label class="form-label"><i class="fas fa-boxes-stacked me-2"></i>Compartments</label>
                        <div id="compartmentsContainer"></div>
                        <button type="button" class="btn btn-secondary mt-2" onclick="addCompartment()">
                          <i class="fas fa-plus me-1"></i>Add Compartment
                        </button>
                      </div>

                    </div>

                    <div class="d-grid mt-4">
                      <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus-circle me-2"></i>Add Locker
                      </button>
                    </div>
                  </form>
        </div>
      </div>
    </div>


    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let compartmentCount = 0;

      function addCompartment() {
        const container = document.getElementById('compartmentsContainer');

        const div = document.createElement('div');
        div.className = "row g-3 mb-2 align-items-end compartment-row";
        div.innerHTML = `
        <div class="col-md-5">
          <label class="form-label">Compartment ID</label>
          <input type="text" class="form-control" name="compartments[${compartmentCount}][compartmentId]" value="${compartmentCount}" required />
        </div>
        <div class="col-md-5">
          <label class="form-label">Size</label>
          <select class="form-select" name="compartments[${compartmentCount}][size]" required>
            <option value="">Select size</option>
            <option value="small">Small</option>
            <option value="medium">Medium</option>
            <option value="large">Large</option>
          </select>
        </div>
        <div class="col-md-2 text-end">
          <button type="button" class="btn btn-danger" onclick="removeCompartment(this)">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
        container.appendChild(div);
        compartmentCount++;
      }

      function removeCompartment(btn) {
        btn.closest('.compartment-row').remove();
        // Reindex remaining compartments
        const rows = document.querySelectorAll('.compartment-row');
        compartmentCount = 0;
        rows.forEach((row, i) => {
          row.querySelectorAll('input, select').forEach(el => {
            if (el.name.includes('compartmentId')) {
              el.name = `compartments[${i}][compartmentId]`;
              el.value = `C${i + 1}`;
            }
            if (el.name.includes('size')) {
              el.name = `compartments[${i}][size]`;
            }
          });
          compartmentCount++;
        });
      }

      const searchInput = document.getElementById('locationSearch');
      const suggestions = document.getElementById('suggestions');

      searchInput.addEventListener('input', async () => {
        const query = searchInput.value;
        if (!query) {
          suggestions.innerHTML = '';
          return;
        }

        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await res.json();
        suggestions.innerHTML = '';

        data.slice(0, 5).forEach(place => {
          const li = document.createElement('li');
          li.className = 'list-group-item list-group-item-action';
          li.textContent = place.display_name;
          li.addEventListener('click', () => {
            searchInput.value = place.display_name;
            document.getElementById('addressField').value = place.display_name;
            document.getElementById('latField').value = place.lat;
            document.getElementById('lngField').value = place.lon;
            suggestions.innerHTML = '';
          });
          suggestions.appendChild(li);
        });
      });
      const getLocationBtn = document.getElementById('getLocationBtn');

getLocationBtn.addEventListener('click', () => {
  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser.");
    return;
  }

  getLocationBtn.innerHTML = '‚è≥ Getting location...';
  getLocationBtn.disabled = true;

  navigator.geolocation.getCurrentPosition(async (position) => {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;

    document.getElementById('latField').value = lat;
    document.getElementById('lngField').value = lon;

    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
      const data = await res.json();
      const address = data.display_name || 'Address not found';

      document.getElementById('addressField').value = address;
      document.getElementById('locationSearch').value = address;
    } catch (err) {
      alert("Failed to fetch address.");
      console.error(err);
    }

    getLocationBtn.innerHTML = 'üìç Use My Location';
    getLocationBtn.disabled = false;

  }, (err) => {
    alert("Unable to get your location. Permission denied or device error.");
    getLocationBtn.innerHTML = 'üìç Use My Location';
    getLocationBtn.disabled = false;
  });
});

    </script>
</body>

</html>