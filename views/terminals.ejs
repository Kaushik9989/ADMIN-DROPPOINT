<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>

    <!-- Bootstrap & Font Awesome -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Custom Styles -->
    <style>
      body {
        background: linear-gradient(135deg, #6e8efb, #a777e3);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .card {
        border-radius: 15px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        background: rgba(255, 255, 255, 0.95);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
      }
      .btn-primary {
        background: #5a67d8;
        border: none;
        border-radius: 8px;
        padding: 12px;
        transition: background 0.3s ease, transform 0.2s ease;
      }
      .btn-primary:hover {
        background: #4c51bf;
        transform: scale(1.05);
      }
      .btn-danger,
      .btn-outline-danger {
        border-radius: 8px;
        transition: background 0.3s ease, transform 0.2s ease;
      }
      .btn-danger:hover,
      .btn-outline-danger:hover {
        transform: scale(1.05);
      }
      .form-control {
        border-radius: 8px;
        padding: 10px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }
      .form-control:focus {
        border-color: #5a67d8;
        box-shadow: 0 0 8px rgba(90, 103, 216, 0.3);
      }
      .alert {
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .form-label {
        font-weight: 500;
        color: #333;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .table {
        border-radius: 8px;
        overflow: hidden;
      }
      .table th,
      .table td {
        vertical-align: middle;
      }
      .card-header {
        border-radius: 8px 8px 0 0;
      }
      .badge {
        font-size: 0.9em;
        padding: 6px 12px;
        border-radius: 12px;
      }

    body{font-family:sans-serif;margin:18px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle}
    tr.online{background:#e8fff0}
    tr.offline{background:#fff6f6;color:#444}
    .badge{padding:4px 8px;border-radius:4px;font-size:12px;display:inline-block;min-width:64px;text-align:center}
    .badge.online{background:#16a34a;color:#fff}
    .badge.offline{background:#ef4444;color:#fff}
    .muted{color:#666;font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace; font-size:12px}
       }
    </style>
  </head>
  <body class="bg-light min-vh-100">
    <!-- Top Navigation Bar -->
    <nav
      class="navbar navbar-expand-lg navbar-dark"
      style="background: #5a67d8; position: fixed; width: 100%; z-index: 1050"
    >
      <div class="container-fluid">
        <a class="navbar-brand ms-3" href="/admin/dashboard">
          <i class="fas fa-tools me-2"></i>Admin Panel
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#topNavbar"
          aria-controls="topNavbar"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="topNavbar">
          <ul class="navbar-nav ms-auto me-3 mb-2 mb-lg-0 align-items-center">
            <li class="nav-item me-3">
              <span class="navbar-text text-white">
                Welcome, <%= user.username %>
                <span class="badge bg-primary">Admin</span>
              </span>
            </li>
            <li class="nav-item">
              <a class="btn btn-outline-light btn-sm" href="/admin/logout">
                <i class="fas fa-sign-out-alt me-1"></i>Logout
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="d-flex" style="padding-top: 56px">
      <!-- Sidebar -->
      <nav
        class="bg-white shadow-lg vh-100 p-3"
        style="width: 250px; position: fixed; top: 56px; left: 0"
      >
        <ul class="nav flex-column">
          <li class="nav-item mb-2">
            <a class="nav-link text-dark" href="/admin/dashboard"
              ><i class="fas fa-home me-2"></i>Dashboard</a
            >
          </li>
          <li class="nav-item mb-2">
            <a class="nav-link text-dark" href="/admin/add-locker"
              ><i class="fas fa-plus me-2"></i>Add Locker</a
            >
            <li class="nav-item mb-2">
      <a class="nav-link text-dark" href="/merchantValidate"><i class="fa-solid fa-users me-2"></i>Validate Merchants</a>
    </li>
          </li>
           <li class="nav-item mb-2">
            <a class="nav-link text-dark" href="/admin/analytics"
              ><i class="fa-solid fa-chart-line me-2"></i>Website Analytics</a
            >
          </li>
          </li>
           <li class="nav-item mb-2">
      <a class="nav-link text-dark" href="/Action_funnel"><i class="fa-solid fa-chart-line me-2"></i>Funnel Actions</a>
    </li>
    <li class="nav-item mb-2">
      <a class="nav-link text-dark" href="/users"><i class="fa-solid fa-chart-line me-2"></i>User Management</a>
    </li>
          <li class="nav-item mb-2">
            <a class="nav-link text-dark" href="/admin/bookings"
              ><i class="fas fa-list me-2"></i>All Bookings</a
            >
          
          <li class="nav-item mt-4">
            <a class="btn btn-outline-danger w-100" href="/admin/logout"
              ><i class="fas fa-sign-out-alt me-2"></i>Logout</a
            >
          </li>
        </ul>
      </nav>
  <h1>Live Terminals</h1>
  <p class="muted">Realtime updates powered by Socket.io — last <strong><%= terminals.length %></strong> loaded</p>
  <a href="/terminals/add" class="btn">➕ Add New Terminal</a>

  <table id="terminals-table" aria-live="polite">
    <thead>
      <tr>
        <th>Terminal ID</th>
        <th>Last Seen (IST)</th>
        <th>Local Time (IST)</th>
        <th>Status</th>
        <th>Battery</th>
        <th>CPU%</th>
        <th>Memory</th>
        <th>Disk</th>
        <th>WiFi</th>
        <th>Uptime</th>
        <th>Extra</th>
      </tr>
    </thead>
    <tbody>
      <% terminals.forEach(t => { %>
        <tr id="t-<%= t.terminalId %>" class="<%= t.isOnline ? 'online' : 'offline' %>">
          <td class="tid"><%= t.terminalId %></td>
          <td class="lastSeen mono"><%= t.lastSeenIST %></td>
          <td class="localTime mono"><%= t.localTimeIST %></td>
          <td class="status">
            <span class="badge <%= t.isOnline ? 'online' : 'offline' %>"><%= t.isOnline ? 'ONLINE' : 'OFFLINE' %></span>
          </td>
          <td class="battery"><%= (t._healthShort && t._healthShort.batteryPercent != null) ? (t._healthShort.batteryPercent + '%') : '—' %></td>
          <td class="cpu"><%= (t._healthShort && t._healthShort.cpuLoad != null) ? (t._healthShort.cpuLoad + '%') : '—' %></td>
          <td class="memory"><%= t._healthShort ? t._healthShort.memStr : '—' %></td>
          <td class="disk mono"><%= t._healthShort ? t._healthShort.diskSummary : '—' %></td>
          <td class="wifi"><%= t._healthShort ? t._healthShort.wifiSsid : '—' %></td>
          <td class="uptime mono"><%= t._healthShort ? t._healthShort.uptime : '—' %></td>
          <td class="extra mono"><%= (t.status && t.status.extra) ? JSON.stringify(t.status.extra) : '—' %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const THRESHOLD_MS = <%= (process.env.HEARTBEAT_THRESHOLD_MS && Number(process.env.HEARTBEAT_THRESHOLD_MS)) || 10000 %>;
    const socket = io();

    // client helper: convert to IST string for live updates
    function toIST(dateStr) {
      if (!dateStr) return '—';
      try {
        return new Date(dateStr).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
      } catch (e) {
        return new Date(dateStr).toISOString();
      }
    }

    // derive short health display from status.health
    function healthShort(h) {
      if (!h) return {
        battery: '—', cpu: '—', mem: '—', disk: '—', wifi: '—', uptime: '—'
      };

      const battery = (h.battery && typeof h.battery.percent === 'number') ? (h.battery.percent + '%') : (h.battery && typeof h.battery.percent === 'string' ? h.battery.percent : '—');
      const cpu = (h.cpu && typeof h.cpu.loadPercent === 'number') ? (h.cpu.loadPercent + '%') : '—';
      const mem = (h.memory && typeof h.memory.usedBytes === 'number' && typeof h.memory.totalBytes === 'number') ? 
        `${Math.round(h.memory.usedBytes/1024/1024)}MB / ${Math.round(h.memory.totalBytes/1024/1024)}MB` : '—';
      const disk = (h.disk && h.disk.length) ? h.disk.map(d => {
        if (d.used && d.size) return `${Math.round((d.used||0)/1024/1024)}MB/${Math.round((d.size||0)/1024/1024)}MB`;
        if (d.used) return `${Math.round((d.used||0)/1024/1024)}MB`;
        return '—';
      }).join(', ') : '—';
      const wifi = (h.wifi && h.wifi.ssid) ? h.wifi.ssid : '—';
      const uptime = (typeof h.uptimeSeconds === 'number') ? `${Math.floor(h.uptimeSeconds/3600)}h ${Math.floor((h.uptimeSeconds%3600)/60)}m` : '—';

      return { battery, cpu, mem, disk, wifi, uptime };
    }

    // update or insert row when a terminal:status event arrives
    socket.on('terminal:status', (payload) => {
      try {
        // payload expected: { terminalId, isOnline, lastSeen, status }
        const id = 't-' + payload.terminalId;
        let tr = document.getElementById(id);
        const isOnline = !!payload.isOnline || (payload.lastSeen && (Date.now() - new Date(payload.lastSeen).getTime() <= THRESHOLD_MS));

        // prepare fields
        const lastSeenStr = toIST(payload.lastSeen);
        const localTimeStr = payload.status && payload.status.localTime ? toIST(payload.status.localTime) : '—';
        const health = payload.status && payload.status.health ? payload.status.health : null;
        const hs = healthShort(health);
        const extra = payload.status && payload.status.extra ? JSON.stringify(payload.status.extra) : '—';

        if (!tr) {
          tr = document.createElement('tr');
          tr.id = id;
          tr.className = isOnline ? 'online' : 'offline';
          tr.innerHTML = `
            <td class="tid">${payload.terminalId}</td>
            <td class="lastSeen mono">${lastSeenStr}</td>
            <td class="localTime mono">${localTimeStr}</td>
            <td class="status"><span class="badge ${isOnline ? 'online' : 'offline'}">${isOnline ? 'ONLINE' : 'OFFLINE'}</span></td>
            <td class="battery">${hs.battery}</td>
            <td class="cpu">${hs.cpu}</td>
            <td class="memory">${hs.mem}</td>
            <td class="disk mono">${hs.disk}</td>
            <td class="wifi">${hs.wifi}</td>
            <td class="uptime mono">${hs.uptime}</td>
            <td class="extra mono">${extra}</td>
          `;
          document.querySelector('#terminals-table tbody').appendChild(tr);
          return;
        }

        // existing row: update cells
        tr.className = isOnline ? 'online' : 'offline';
        const lastSeenCell = tr.querySelector('.lastSeen');
        const localTimeCell = tr.querySelector('.localTime');
        const statusCell = tr.querySelector('.status');
        const batteryCell = tr.querySelector('.battery');
        const cpuCell = tr.querySelector('.cpu');
        const memCell = tr.querySelector('.memory');
        const diskCell = tr.querySelector('.disk');
        const wifiCell = tr.querySelector('.wifi');
        const uptimeCell = tr.querySelector('.uptime');
        const extraCell = tr.querySelector('.extra');

        if (lastSeenCell) lastSeenCell.textContent = lastSeenStr;
        if (localTimeCell) localTimeCell.textContent = localTimeStr;
        if (statusCell) statusCell.innerHTML = `<span class="badge ${isOnline ? 'online' : 'offline'}">${isOnline ? 'ONLINE' : 'OFFLINE'}</span>`;
        if (batteryCell) batteryCell.textContent = hs.battery;
        if (cpuCell) cpuCell.textContent = hs.cpu;
        if (memCell) memCell.textContent = hs.mem;
        if (diskCell) diskCell.textContent = hs.disk;
        if (wifiCell) wifiCell.textContent = hs.wifi;
        if (uptimeCell) uptimeCell.textContent = hs.uptime;
        if (extraCell) extraCell.textContent = extra;

        // quick highlight on change
        tr.animate(
          [{ backgroundColor: isOnline ? '#eaffef' : '#fff4f2' }, { backgroundColor: '' }],
          { duration: 700 }
        );
      } catch (err) {
        console.error('socket update error', err);
      }
    });

    // reconnect/debug handlers
    socket.on('connect', () => console.log('[socket] connected', socket.id));
    socket.on('disconnect', () => console.warn('[socket] disconnected'));
    socket.on('connect_error', (err) => console.error('[socket] connect_error', err));
  </script>
</body>
</html>
